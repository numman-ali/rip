# Event Frames (Phase 1)

Summary
- Canonical internal event schema for all surfaces.
- Frames are compact structs in Rust; JSON only at the edges (SSE/logging).

Schema (Phase 1 — stream-aware envelope)
- `id`: string (uuid)
- `session_id`: string (uuid) (compat alias; equals `stream_id`)
- `stream_kind`: `"session"` | `"task"` | `"continuity"` | `"artifact"` (extensible)
- `stream_id`: string (e.g. session id, task id, continuity id)
- `seq`: u64 (monotonic per `{stream_kind, stream_id}`)
- `timestamp_ms`: u64 (unix epoch ms)
- `type`: string (frame type)
- `payload`: fields defined by `type` (serialized alongside `type`)

Frame types
- `session_started`
  - `input`: string
- `output_text_delta`
  - `delta`: string
- `session_ended`
  - `reason`: string
- `continuity_created`
  - `workspace`: string (current: workspace root path)
  - `title`: string | null
- `continuity_message_appended`
  - `actor_id`: string
  - `origin`: string
  - `content`: string
- `continuity_run_spawned`
  - `run_session_id`: string (uuid)
  - `message_id`: string (uuid)
  - `actor_id`: string (optional; may be absent in older logs)
  - `origin`: string (optional; may be absent in older logs)
- `continuity_context_selection_decided`
  - Purpose: record context selection strategy decisions (strategy/budgets/reasons/inputs) as continuity truth so strategy evolution is auditable under cache rotation (ADR-0016).
  - `run_session_id`: string (uuid)
  - `message_id`: string (uuid) (the triggering `continuity_message_appended` id)
  - `compiler_id`: string (example: `rip.context_compiler.v1`)
  - `compiler_strategy`: string (example: `recent_messages_v1` | `summaries_recent_messages_v1` | `hierarchical_summaries_recent_messages_v1`)
  - `limits`: object (stable, versioned keys only)
    - v0.1: `{ "recent_messages_v1_limit": 16 }`
  - `compaction_checkpoint`: object | null (present when the selected strategy uses a summary checkpoint)
    - `checkpoint_id`: string (uuid)
    - `summary_kind`: string
    - `summary_artifact_id`: string (artifact id; schema `rip.compaction_summary.v1`)
    - `to_seq`: u64
  - `compaction_checkpoints`: array (optional; may be empty)
    - Purpose: record all selected compaction checkpoints when the strategy uses multiple summary refs (example: `hierarchical_summaries_recent_messages_v1`).
    - Each entry:
      - `checkpoint_id`: string (uuid)
      - `summary_kind`: string
      - `summary_artifact_id`: string (artifact id; schema `rip.compaction_summary.v1`)
      - `to_seq`: u64
  - `resets`: array (optional; may be empty)
    - Each entry: `{ "input": string, "action": string, "reason": string, "ref": object | null }` (stable values/refs only)
  - `reason`: object | null (stable values only)
  - `actor_id`: string
  - `origin`: string
- `continuity_context_compiled`
  - Purpose: record the compiled context bundle used to start a run (provider-agnostic; replayable; enables provider cursor rotation).
  - `run_session_id`: string (uuid)
  - `bundle_artifact_id`: string (artifact id; schema `rip.context_bundle.v1`)
  - `compiler_id`: string (example: `rip.context_compiler.v1`)
  - `compiler_strategy`: string (example: `recent_messages_v1`)
  - `from_seq`: u64 (inclusive cut point in the continuity stream used for compilation)
  - `from_message_id`: string | null (anchor message id when known)
  - `actor_id`: string
  - `origin`: string
- `continuity_provider_cursor_updated`
  - Purpose: record provider conversation cursor cache state changes (rotation/reset/updates) as continuity truth (ADR-0015).
  - `provider`: string (example: `openresponses`)
  - `endpoint`: string | null (provider endpoint key; no secrets)
  - `model`: string | null
  - `cursor`: object | null (provider-specific cursor payload; v0.1 uses stable keys)
    - Open Responses v0.1 cursor payload: `{ "previous_response_id": "<response_id>" }`
  - `action`: string (example: `set` | `cleared` | `rotated`)
  - `reason`: string | null (stable, user-supplied or system-defined)
  - `run_session_id`: string | null (links the update to a run when produced by a run)
  - `actor_id`: string
  - `origin`: string
- `continuity_compaction_checkpoint_created`
  - Purpose: record a deterministic compaction checkpoint (cut point + summary artifact) used by `context.compile` strategies.
  - `checkpoint_id`: string (uuid)
  - `cut_rule_id`: string (example: `stride_messages_v1/10000`)
  - `summary_kind`: string (example: `cumulative_v1`)
  - `summary_artifact_id`: string (artifact id; schema `rip.compaction_summary.v1`)
  - `from_seq`: u64 (inclusive coverage start in the continuity stream)
  - `from_message_id`: string | null (coverage start message id when applicable)
  - `to_seq`: u64 (inclusive coverage end; must be a `continuity_message_appended` boundary)
  - `to_message_id`: string | null (coverage end message id when applicable; required when known)
  - `actor_id`: string
  - `origin`: string
- `continuity_compaction_auto_schedule_decided`
  - Purpose: record a policy-driven decision about whether to run `compaction.auto` (ADR-0013).
  - `decision_id`: string (uuid)
  - `policy_id`: string (versioned policy identifier capturing resolved parameters)
  - `decision`: string (example: `scheduled` | `skipped_inflight`)
  - `execute`: bool
  - `stride_messages`: u64
  - `max_new_checkpoints`: u32
  - `block_on_inflight`: bool
  - `message_count`: u64
  - `cut_rule_id`: string
  - `planned`: array
    - Each entry: `target_message_ordinal`, `to_seq`, `to_message_id`
  - `job_id`: string | null (present when `decision=scheduled`)
  - `job_kind`: string | null (present when `decision=scheduled`)
  - `reason`: object | null (optional; stable values only)
  - `actor_id`: string
  - `origin`: string
- `continuity_job_spawned`
  - Purpose: represent a background job over the continuity stream (summarizers/indexers/etc.) as continuity truth (ADR-0012).
  - `job_id`: string (uuid)
  - `job_kind`: string (example: `compaction_summarizer_v1`)
  - `details`: object | null (job-specific, but must only contain stable values/refs)
  - `actor_id`: string
  - `origin`: string
- `continuity_job_ended`
  - Purpose: terminal status for a background job represented in continuity truth (ADR-0012).
  - `job_id`: string (uuid)
  - `job_kind`: string
  - `status`: string (example: `completed` | `failed` | `cancelled`)
  - `result`: object | null (job-specific result; stable ids/refs only)
  - `error`: string | null (present when `status=failed`)
  - `actor_id`: string
  - `origin`: string
- `continuity_run_ended`
  - `run_session_id`: string (uuid)
  - `message_id`: string (uuid)
  - `reason`: string
  - `actor_id`: string (optional; may be absent in older logs)
  - `origin`: string (optional; may be absent in older logs)
- `continuity_tool_side_effects`
  - Purpose: continuity-truth logging of workspace mutations performed by in-run tools (provenance-first; replayable ordering).
  - `run_session_id`: string (uuid)
  - `tool_id`: string (uuid)
  - `tool_name`: string
  - `affected_paths`: string[] | null (normalized relative paths; null when unknown/unbounded, e.g. `bash`)
  - `checkpoint_id`: string | null (auto-checkpoint id created immediately before the tool, if any)
  - `actor_id`: string
  - `origin`: string
- `continuity_branched`
  - `parent_thread_id`: string (continuity id)
  - `parent_seq`: u64 (inclusive cut point in the parent continuity stream)
  - `parent_message_id`: string | null
  - `actor_id`: string
  - `origin`: string
- `continuity_handoff_created`
  - `from_thread_id`: string (continuity id)
  - `from_seq`: u64 (inclusive source point in the parent continuity stream)
  - `from_message_id`: string | null
  - `summary_artifact_id`: string | null
  - `summary_markdown`: string | null
  - `actor_id`: string
  - `origin`: string
  - Invariant: at least one of `summary_artifact_id` or `summary_markdown` is non-null.
  - If `summary_artifact_id` is set, it should reference a handoff context bundle artifact (`docs/03_contracts/handoff_context_bundle.md`).
- `tool_started`
  - `tool_id`: string (uuid)
  - `name`: string
  - `args`: object
  - `timeout_ms`: u64 | null
- `tool_stdout`
  - `tool_id`: string
  - `chunk`: string
- `tool_stderr`
  - `tool_id`: string
  - `chunk`: string
- `tool_ended`
  - `tool_id`: string
  - `exit_code`: i32
  - `duration_ms`: u64
  - `artifacts`: object | null
- `tool_failed`
  - `tool_id`: string
  - `error`: string
- `provider_event`
  - `provider`: string (e.g. `openresponses`)
  - `status`: `event` | `done` | `invalid_json`
  - `event_name`: string | null (SSE `event:` value)
  - `data`: object | null (parsed Open Responses event payload)
  - `raw`: string | null (raw `data:` payload, only when needed)
  - `errors`: string[] (schema/validation errors)
  - `response_errors`: string[] (ResponseResource validation errors)
- `openresponses_request`
  - Debug/observability frame. Emitted only when `RIP_OPENRESPONSES_DUMP_REQUEST=1`.
  - `endpoint`: string
  - `model`: string | null (best-effort from the request body `model` field)
  - `request_index`: u64 (0-based per session)
  - `kind`: string (best-effort label, e.g. `prompt`, `initial_items`, `followup`)
  - `body_artifact_id`: string (artifact blob id under `.rip/artifacts/blobs/<id>`)
  - `body_bytes`: u64 (bytes stored in the artifact blob; may be truncated)
  - `total_bytes`: u64 (original JSON bytes length)
  - `truncated`: bool
- `checkpoint_created`
  - `checkpoint_id`: string (uuid)
  - `label`: string
  - `created_at_ms`: u64
  - `files`: string[] (relative paths)
  - `auto`: bool
  - `tool_name`: string | null
- `checkpoint_rewound`
  - `checkpoint_id`: string (uuid)
  - `label`: string
  - `files`: string[] (relative paths)
- `checkpoint_failed`
  - `action`: `create` | `rewind`
  - `error`: string

Invariants
- `seq` starts at 0 and increments by 1 for each emitted frame in the same stream.
- Frames are append-only and ordered within a stream (`{stream_kind, stream_id}`).
- `session_ended` is the terminal frame for a runtime-generated session.
- Background tool tasks are modeled as **task event streams**:
  - `stream_kind="task"`, `stream_id=task_id` (`session_id` remains an alias for compatibility).
  - Task streams do not emit `session_started/session_ended`; lifecycle is expressed via `tool_task_*` frames.
- Continuities (“threads”) are modeled as **continuity event streams**:
  - `stream_kind="continuity"`, `stream_id=continuity_id` (`session_id` remains an alias for compatibility).
- Provider adapters emit `provider_event` for every SSE event (no drops).
- Automatic checkpoint events for file-edit tools are emitted before the tool starts.
- `continuity_tool_side_effects` is appended to the continuity stream only when the run is linked to a continuity (`continuity_run` exists).
- `continuity_tool_side_effects` must be emitted after the tool completes (`tool_ended`/`tool_failed`) and before `continuity_run_ended` for the same `run_session_id`.
- `continuity_context_compiled` is appended to the continuity stream only when the run is linked to a continuity (`continuity_run` exists).
- `continuity_context_compiled` must be emitted after `continuity_run_spawned` and before `continuity_run_ended` for the same `run_session_id`.
- `continuity_context_selection_decided` is appended to the continuity stream only when the run is linked to a continuity (`continuity_run` exists).
- `continuity_context_selection_decided` must be emitted after `continuity_run_spawned` and before `continuity_context_compiled` for the same `run_session_id`.
- `continuity_provider_cursor_updated` is appended to the continuity stream only when the run is linked to a continuity (`continuity_run` exists) or when a surface explicitly rotates/resets provider cursor caches.
- When `continuity_provider_cursor_updated.run_session_id` is set, it must be emitted before `continuity_run_ended` for the same `run_session_id`.
- `continuity_compaction_checkpoint_created` is appended to the continuity stream and must reference a message boundary (`to_seq`/`to_message_id` identify a `continuity_message_appended` event).
- Multiple `continuity_compaction_checkpoint_created` frames may exist for the same `to_seq` (later frames supersede earlier ones by stream order; history is never overwritten).
- `continuity_compaction_auto_schedule_decided` is appended to the continuity stream when the scheduler encounters eligible work; it must only include stable values/refs.
- `continuity_job_spawned` and `continuity_job_ended` are appended to the continuity stream.
- `continuity_job_ended` is terminal for `{job_id}` and should appear at most once per `job_id`.

Example
```
{"id":"...","session_id":"...","stream_kind":"session","stream_id":"...","timestamp_ms":0,"seq":0,"type":"session_started","input":"hi"}
{"id":"...","session_id":"...","stream_kind":"session","stream_id":"...","timestamp_ms":1,"seq":1,"type":"provider_event","provider":"openresponses","status":"event","event_name":"response.output_text.delta","data":{"type":"response.output_text.delta","delta":"hi"},"raw":null,"errors":[],"response_errors":[]}
{"id":"...","session_id":"...","stream_kind":"session","stream_id":"...","timestamp_ms":2,"seq":2,"type":"output_text_delta","delta":"ack: hi"}
{"id":"...","session_id":"...","stream_kind":"session","stream_id":"...","timestamp_ms":3,"seq":3,"type":"session_ended","reason":"completed"}
```

Phase 2 (planned additions)

Schema (planned tightening)
- Phase 2 removes v1-only ambiguity by making `session_id` session-only (dropping it from non-session streams) once all surfaces consume `{stream_kind, stream_id}`.

- Provenance (planned):
  - Frames that represent an input/action should carry `actor_id` and `origin` metadata so shared/team continuities remain replayable.

- Continuities (planned):
  - `continuity_thread_referenced`: `{from_thread_id, to_thread_id, selector, extracted_artifact_id, actor_id, origin}`

- Context retrieval (planned; hybrid search + rerank; ADR-0019):
  - `continuity_context_retrieval_decided`: `{run_session_id, message_id, query, strategy_id, index_artifact_ids, results_artifact_id, actor_id, origin}`

- Background tool tasks:
  - `tool_task_spawned`: `{task_id, tool_name, args, cwd?, title?, execution_mode: pipes|pty, origin_session_id?, artifacts?}`
  - `tool_task_status`: `{task_id, status, exit_code?, started_at_ms?, ended_at_ms?, artifacts?, error?}`
  - `tool_task_cancel_requested`: `{task_id, reason}`
  - `tool_task_cancelled`: `{task_id, reason, wall_time_ms?}`
  - `tool_task_output_delta`: `{task_id, stream: stdout|stderr|pty, chunk, artifacts?}`
  - `tool_task_stdin_written`: `{task_id, chunk_b64}` (PTY only)
  - `tool_task_resized`: `{task_id, rows, cols}`
  - `tool_task_signalled`: `{task_id, signal}`
- Artifact-backed outputs:
  - `artifact_written`: `{artifact_id, kind, bytes, digest, preview?}`
  - Tool frames may include bounded previews plus `artifact_refs` when full output is stored externally.
- Skills (Agent Skills/OpenSkills):
  - `skill_catalog_updated`: `{count, roots, collisions?}`
  - `skill_loaded`: `{name, path, digest, frontmatter, warnings?}`
  - `skill_invoked`: `{name, args?, mode:manual|auto, effective_allowed_tools?}`
  - `skill_warning`: `{name?, kind, detail}`

#!/usr/bin/env bash
set -euo pipefail

require_cargo_subcmd() {
  local name="$1"
  local install_hint="$2"
  if ! cargo "$name" --version >/dev/null 2>&1; then
    echo "missing cargo subcommand: $name"
    echo "install: $install_hint"
    exit 1
  fi
}

"$(dirname "$0")/check-fast"

cargo test --workspace --doc

require_cargo_subcmd llvm-cov "cargo install cargo-llvm-cov && rustup component add llvm-tools-preview"
# Coverage is a CI gate, but Phase 1 is still moving quickly. Keep the bar high
# enough to prevent regressions without blocking iteration; ratchet upward as the
# runtime matures.
cargo llvm-cov --workspace --fail-under-lines 90 --fail-under-regions 90 --fail-under-functions 90

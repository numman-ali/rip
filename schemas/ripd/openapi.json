{
  "openapi": "3.1.0",
  "info": {
    "title": "RIP Agent Server",
    "description": "Agent session control plane (HTTP/SSE).",
    "license": {
      "name": ""
    },
    "version": "0.1.0"
  },
  "paths": {
    "/sessions": {
      "post": {
        "operationId": "create_session",
        "responses": {
          "201": {
            "description": "Session created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SessionCreated"
                }
              }
            }
          }
        }
      }
    },
    "/sessions/{id}/cancel": {
      "post": {
        "operationId": "cancel_session",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Session id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Session canceled"
          },
          "404": {
            "description": "Session not found"
          }
        }
      }
    },
    "/sessions/{id}/events": {
      "get": {
        "operationId": "stream_events",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Session id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "SSE stream of event frames"
          },
          "404": {
            "description": "Session not found"
          }
        }
      }
    },
    "/sessions/{id}/input": {
      "post": {
        "operationId": "send_input",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Session id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/InputPayload"
              }
            }
          },
          "required": true
        },
        "responses": {
          "202": {
            "description": "Input accepted"
          },
          "404": {
            "description": "Session not found"
          }
        }
      }
    },
    "/tasks": {
      "get": {
        "operationId": "list_tasks",
        "responses": {
          "200": {
            "description": "List tasks",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/TaskStatusResponse"
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "operationId": "create_task",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TaskSpawnPayload"
              }
            }
          },
          "required": true
        },
        "responses": {
          "201": {
            "description": "Task created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TaskCreated"
                }
              }
            }
          },
          "400": {
            "description": "Invalid task request"
          }
        }
      }
    },
    "/tasks/{id}": {
      "get": {
        "operationId": "task_status",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Task id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Task status",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TaskStatusResponse"
                }
              }
            }
          },
          "404": {
            "description": "Task not found"
          }
        }
      }
    },
    "/tasks/{id}/cancel": {
      "post": {
        "operationId": "cancel_task",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Task id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TaskCancelPayload"
              }
            }
          },
          "required": true
        },
        "responses": {
          "202": {
            "description": "Cancel requested"
          },
          "404": {
            "description": "Task not found"
          }
        }
      }
    },
    "/tasks/{id}/events": {
      "get": {
        "operationId": "stream_task_events",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Task id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "SSE stream of task event frames"
          },
          "404": {
            "description": "Task not found"
          }
        }
      }
    },
    "/tasks/{id}/output": {
      "get": {
        "operationId": "task_output",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Task id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Fetch task output (range)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TaskOutputResponse"
                }
              }
            }
          },
          "404": {
            "description": "Task not found"
          }
        }
      }
    },
    "/tasks/{id}/resize": {
      "post": {
        "operationId": "task_resize",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Task id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TaskResizePayload"
              }
            }
          },
          "required": true
        },
        "responses": {
          "202": {
            "description": "Resize accepted"
          },
          "400": {
            "description": "Invalid resize request"
          },
          "404": {
            "description": "Task not found"
          }
        }
      }
    },
    "/tasks/{id}/signal": {
      "post": {
        "operationId": "task_signal",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Task id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TaskSignalPayload"
              }
            }
          },
          "required": true
        },
        "responses": {
          "202": {
            "description": "Signal accepted"
          },
          "400": {
            "description": "Invalid signal request"
          },
          "404": {
            "description": "Task not found"
          }
        }
      }
    },
    "/tasks/{id}/stdin": {
      "post": {
        "operationId": "task_write_stdin",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Task id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TaskWriteStdinPayload"
              }
            }
          },
          "required": true
        },
        "responses": {
          "202": {
            "description": "Stdin accepted"
          },
          "400": {
            "description": "Invalid stdin request"
          },
          "404": {
            "description": "Task not found"
          }
        }
      }
    },
    "/threads": {
      "get": {
        "operationId": "thread_list",
        "responses": {
          "200": {
            "description": "List threads",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/ThreadMeta"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/threads/ensure": {
      "post": {
        "operationId": "thread_ensure",
        "responses": {
          "200": {
            "description": "Default thread ensured",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ThreadEnsureResponse"
                }
              }
            }
          }
        }
      }
    },
    "/threads/{id}": {
      "get": {
        "operationId": "thread_get",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Thread id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Thread metadata",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ThreadMeta"
                }
              }
            }
          },
          "404": {
            "description": "Thread not found"
          }
        }
      }
    },
    "/threads/{id}/branch": {
      "post": {
        "operationId": "thread_branch",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Parent thread id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ThreadBranchPayload"
              }
            }
          },
          "required": true
        },
        "responses": {
          "201": {
            "description": "Branch created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ThreadBranchResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid branch request"
          },
          "404": {
            "description": "Thread or branch point not found"
          }
        }
      }
    },
    "/threads/{id}/compaction-checkpoint": {
      "post": {
        "operationId": "thread_compaction_checkpoint",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Thread id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ThreadCompactionCheckpointPayload"
              }
            }
          },
          "required": true
        },
        "responses": {
          "201": {
            "description": "Compaction checkpoint created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ThreadCompactionCheckpointResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid checkpoint request"
          },
          "404": {
            "description": "Thread or cut point not found"
          }
        }
      }
    },
    "/threads/{id}/events": {
      "get": {
        "operationId": "thread_stream_events",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Thread id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "SSE stream of thread event frames"
          },
          "404": {
            "description": "Thread not found"
          }
        }
      }
    },
    "/threads/{id}/handoff": {
      "post": {
        "operationId": "thread_handoff",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Source thread id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ThreadHandoffPayload"
              }
            }
          },
          "required": true
        },
        "responses": {
          "201": {
            "description": "Handoff thread created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ThreadHandoffResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid handoff request"
          },
          "404": {
            "description": "Thread or handoff point not found"
          }
        }
      }
    },
    "/threads/{id}/messages": {
      "post": {
        "operationId": "thread_post_message",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "Thread id",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ThreadPostMessagePayload"
              }
            }
          },
          "required": true
        },
        "responses": {
          "202": {
            "description": "Message accepted and run started",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ThreadPostMessageResponse"
                }
              }
            }
          },
          "404": {
            "description": "Thread not found"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "ApiToolTaskExecutionMode": {
        "type": "string",
        "enum": [
          "pipes",
          "pty"
        ]
      },
      "ApiToolTaskStatus": {
        "type": "string",
        "enum": [
          "queued",
          "running",
          "exited",
          "cancelled",
          "failed"
        ]
      },
      "InputPayload": {
        "type": "object",
        "required": [
          "input"
        ],
        "properties": {
          "input": {
            "type": "string"
          }
        }
      },
      "SessionCreated": {
        "type": "object",
        "required": [
          "session_id"
        ],
        "properties": {
          "session_id": {
            "type": "string"
          }
        }
      },
      "TaskCancelPayload": {
        "type": "object",
        "properties": {
          "reason": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "TaskCreated": {
        "type": "object",
        "required": [
          "task_id"
        ],
        "properties": {
          "task_id": {
            "type": "string"
          }
        }
      },
      "TaskOutputResponse": {
        "type": "object",
        "required": [
          "task_id",
          "stream",
          "content",
          "offset_bytes",
          "bytes",
          "total_bytes",
          "truncated",
          "artifact_id",
          "path"
        ],
        "properties": {
          "artifact_id": {
            "type": "string"
          },
          "bytes": {
            "type": "integer",
            "minimum": 0
          },
          "content": {
            "type": "string"
          },
          "offset_bytes": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "path": {
            "type": "string"
          },
          "stream": {
            "$ref": "#/components/schemas/TaskOutputStream"
          },
          "task_id": {
            "type": "string"
          },
          "total_bytes": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "truncated": {
            "type": "boolean"
          }
        }
      },
      "TaskOutputStream": {
        "type": "string",
        "enum": [
          "stdout",
          "stderr",
          "pty"
        ]
      },
      "TaskResizePayload": {
        "type": "object",
        "required": [
          "rows",
          "cols"
        ],
        "properties": {
          "cols": {
            "type": "integer",
            "format": "int32",
            "minimum": 0
          },
          "rows": {
            "type": "integer",
            "format": "int32",
            "minimum": 0
          }
        }
      },
      "TaskSignalPayload": {
        "type": "object",
        "required": [
          "signal"
        ],
        "properties": {
          "signal": {
            "type": "string"
          }
        }
      },
      "TaskSpawnPayload": {
        "type": "object",
        "required": [
          "tool"
        ],
        "properties": {
          "args": {},
          "execution_mode": {
            "oneOf": [
              {
                "type": "null"
              },
              {
                "$ref": "#/components/schemas/ApiToolTaskExecutionMode"
              }
            ]
          },
          "origin_session_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "title": {
            "type": [
              "string",
              "null"
            ]
          },
          "tool": {
            "type": "string"
          }
        }
      },
      "TaskStatusResponse": {
        "type": "object",
        "required": [
          "task_id",
          "status",
          "tool",
          "execution_mode"
        ],
        "properties": {
          "artifacts": {},
          "ended_at_ms": {
            "type": [
              "integer",
              "null"
            ],
            "format": "int64",
            "minimum": 0
          },
          "error": {
            "type": [
              "string",
              "null"
            ]
          },
          "execution_mode": {
            "$ref": "#/components/schemas/ApiToolTaskExecutionMode"
          },
          "exit_code": {
            "type": [
              "integer",
              "null"
            ],
            "format": "int32"
          },
          "started_at_ms": {
            "type": [
              "integer",
              "null"
            ],
            "format": "int64",
            "minimum": 0
          },
          "status": {
            "$ref": "#/components/schemas/ApiToolTaskStatus"
          },
          "task_id": {
            "type": "string"
          },
          "title": {
            "type": [
              "string",
              "null"
            ]
          },
          "tool": {
            "type": "string"
          }
        }
      },
      "TaskWriteStdinPayload": {
        "type": "object",
        "required": [
          "chunk_b64"
        ],
        "properties": {
          "chunk_b64": {
            "type": "string"
          }
        }
      },
      "ThreadBranchPayload": {
        "type": "object",
        "properties": {
          "actor_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "from_message_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "from_seq": {
            "type": [
              "integer",
              "null"
            ],
            "format": "int64",
            "minimum": 0
          },
          "origin": {
            "type": [
              "string",
              "null"
            ]
          },
          "title": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "ThreadBranchResponse": {
        "type": "object",
        "required": [
          "thread_id",
          "parent_thread_id",
          "parent_seq"
        ],
        "properties": {
          "parent_message_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "parent_seq": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "parent_thread_id": {
            "type": "string"
          },
          "thread_id": {
            "type": "string"
          }
        }
      },
      "ThreadCompactionCheckpointPayload": {
        "type": "object",
        "properties": {
          "actor_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "origin": {
            "type": [
              "string",
              "null"
            ]
          },
          "stride_messages": {
            "type": [
              "integer",
              "null"
            ],
            "format": "int64",
            "minimum": 0
          },
          "summary_artifact_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "summary_markdown": {
            "type": [
              "string",
              "null"
            ]
          },
          "to_message_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "to_seq": {
            "type": [
              "integer",
              "null"
            ],
            "format": "int64",
            "minimum": 0
          }
        }
      },
      "ThreadCompactionCheckpointResponse": {
        "type": "object",
        "required": [
          "thread_id",
          "checkpoint_id",
          "cut_rule_id",
          "summary_artifact_id",
          "to_seq",
          "to_message_id"
        ],
        "properties": {
          "checkpoint_id": {
            "type": "string"
          },
          "cut_rule_id": {
            "type": "string"
          },
          "summary_artifact_id": {
            "type": "string"
          },
          "thread_id": {
            "type": "string"
          },
          "to_message_id": {
            "type": "string"
          },
          "to_seq": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          }
        }
      },
      "ThreadEnsureResponse": {
        "type": "object",
        "required": [
          "thread_id"
        ],
        "properties": {
          "thread_id": {
            "type": "string"
          }
        }
      },
      "ThreadHandoffPayload": {
        "type": "object",
        "properties": {
          "actor_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "from_message_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "from_seq": {
            "type": [
              "integer",
              "null"
            ],
            "format": "int64",
            "minimum": 0
          },
          "origin": {
            "type": [
              "string",
              "null"
            ]
          },
          "summary_artifact_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "summary_markdown": {
            "type": [
              "string",
              "null"
            ]
          },
          "title": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "ThreadHandoffResponse": {
        "type": "object",
        "required": [
          "thread_id",
          "from_thread_id",
          "from_seq"
        ],
        "properties": {
          "from_message_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "from_seq": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "from_thread_id": {
            "type": "string"
          },
          "thread_id": {
            "type": "string"
          }
        }
      },
      "ThreadMeta": {
        "type": "object",
        "required": [
          "thread_id",
          "created_at_ms",
          "archived"
        ],
        "properties": {
          "archived": {
            "type": "boolean"
          },
          "created_at_ms": {
            "type": "integer",
            "format": "int64",
            "minimum": 0
          },
          "thread_id": {
            "type": "string"
          },
          "title": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "ThreadPostMessagePayload": {
        "type": "object",
        "required": [
          "content"
        ],
        "properties": {
          "actor_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "content": {
            "type": "string"
          },
          "origin": {
            "type": [
              "string",
              "null"
            ]
          }
        }
      },
      "ThreadPostMessageResponse": {
        "type": "object",
        "required": [
          "thread_id",
          "message_id",
          "session_id"
        ],
        "properties": {
          "message_id": {
            "type": "string"
          },
          "session_id": {
            "type": "string"
          },
          "thread_id": {
            "type": "string"
          }
        }
      }
    }
  }
}
